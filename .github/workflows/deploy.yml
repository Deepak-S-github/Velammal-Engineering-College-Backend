name: ðŸš€ Auto Deploy to EC2 on Main Push

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸ” Setup SSH Key
        run: |
          echo "${{ secrets.EC2_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: ðŸ” Generate .env File from GitHub Secret
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created âœ…"

      - name: ðŸ“¤ Upload setup.sh and .env to EC2
        run: |
          scp -o StrictHostKeyChecking=no -i private_key.pem setup.sh ${{ secrets.EC2_HOST }}:~/setup.sh
          scp -o StrictHostKeyChecking=no -i private_key.pem .env ${{ secrets.EC2_HOST }}:~/.env

      - name: ðŸš€ SSH into EC2 and Run Deployment Script
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            echo "âž¡ï¸ Making setup.sh executable..."
            chmod +x ~/setup.sh

            echo "ðŸ“¦ Installing dos2unix if missing..."
            if ! command -v dos2unix &> /dev/null; then
              sudo yum install -y dos2unix || sudo dnf install -y dos2unix
            fi

            echo "ðŸ”§ Converting line endings..."
            dos2unix ~/setup.sh ~/.env

            echo "ðŸš€ Running setup script..."
            bash ~/setup.sh
EOF
