name: ðŸš€ Auto Deploy to EC2 on Main Push

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸ” Setup SSH Key
        run: |
          echo "${{ secrets.EC2_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: ðŸ” Generate .env File from GitHub Secrets
        run: |
          echo "MONGO_URI=\"${{ secrets.MONGO_URI }}\"" >> .env
          echo "DB_NAME=\"${{ secrets.DB_NAME }}\"" >> .env
          echo "CHAT_DB_NAME=\"${{ secrets.CHAT_DB_NAME }}\"" >> .env
          echo "PORT=\"${{ secrets.PORT }}\"" >> .env
          echo "BASE_EMAIL=\"${{ secrets.BASE_EMAIL }}\"" >> .env
          echo "PASSWORD=\"${{ secrets.PASSWORD }}\"" >> .env
          echo "TARGET_EMAIL=\"${{ secrets.TARGET_EMAIL }}\"" >> .env
          echo "ICELL_TARGET_EMAIL=\"${{ secrets.ICELL_TARGET_EMAIL }}\"" >> .env
          echo "GROQ_API_KEY_1=\"${{ secrets.GROQ_API_KEY_1 }}\"" >> .env
          echo "GROQ_API_KEY_2=\"${{ secrets.GROQ_API_KEY_2 }}\"" >> .env
          echo "GROQ_API_KEY_3=\"${{ secrets.GROQ_API_KEY_3 }}\"" >> .env
          echo "GROQ_API_KEY_4=\"${{ secrets.GROQ_API_KEY_4 }}\"" >> .env
          echo "GROQ_API_KEY_5=\"${{ secrets.GROQ_API_KEY_5 }}\"" >> .env
          echo "AWS_ACCESS_KEY_ID=\"${{ secrets.AWS_ACCESS_KEY_ID }}\"" >> .env
          echo "AWS_SECRET_ACCESS_KEY=\"${{ secrets.AWS_SECRET_ACCESS_KEY }}\"" >> .env
          echo "AWS_S3_NAME=\"${{ secrets.AWS_S3_NAME }}\"" >> .env
          echo "AWS_REGION=\"${{ secrets.AWS_REGION }}\"" >> .env
          echo "REACT_APP_BASE_URL=\"${{ secrets.REACT_APP_BASE_URL }}\"" >> .env


      - name: ðŸš€ SSH into EC2 and Run Deployment Script as root
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_HOST }} << 'REMOTE_EOF'
          set -e

          echo "âž¡ï¸ Switching to root..."
          sudo su -c 'bash -s' <<'INNER_EOF'
            echo "âž¡ï¸ Moving .env to /root/.env..."
            mv /home/ec2-user/.env /root/.env

            echo "âž¡ï¸ Moving setup.sh to /root/setup.sh..."
            mv /home/ec2-user/setup.sh /root/setup.sh

            echo "âž¡ï¸ Making setup.sh executable..."
            chmod +x /root/setup.sh

            echo "ðŸ“¦ Installing dos2unix if missing..."
            if ! command -v dos2unix &> /dev/null; then
              yum install -y dos2unix || dnf install -y dos2unix
            fi

            echo "ðŸ”§ Converting line endings..."
            dos2unix /root/setup.sh /root/.env

            echo "ðŸš€ Running setup script..."
            bash /root/setup.sh
          INNER_EOF
          REMOTE_EOF
